<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avocado Ripeness</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('serve_styles', filename='styles.css') }}">
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="big-spinner"></div>
            <div class="loading-text">Analyzing Images</div>
            <div class="loading-subtext">Please wait while AI processes your avocados...</div>
        </div>
    </div>

    <div class="container">
        <h1>ðŸ¥‘ Avocado Check</h1>
        <p class="subtitle">Quickly detect ripeness using AI</p>

        <form action="/predict" method="post" enctype="multipart/form-data">

            <div class="form-group">
                <label>Select AI Model</label>
                <select name="selected_model" required>
                    <option value="" disabled selected>-- Choose a Model --</option>
                    {% for model in models %}
                    <option value="{{ model }}">{{ model }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Upload Images (Select Multiple)</label>
                <div class="file-upload">
                    <span class="file-label-text">Select or Drag Images Here</span>
                    <input type="file" id="file" accept=".png, .jpg, .jpeg" multiple
                        onchange="handleFileSelect(this)">
                </div>
                <div id="preview-container" class="preview-container"></div>
            </div>

            <button type="submit" id="submit-btn">Analyze Now</button>
        </form>
    </div>

    <script>
        let selectedFiles = [];

        function handleFileSelect(input) {
            const newFiles = Array.from(input.files);
            selectedFiles = [...selectedFiles, ...newFiles];
            displayPreviews();
            input.value = ''; // Reset input untuk bisa select file yang sama lagi
        }

        function displayPreviews() {
            const container = document.getElementById('preview-container');
            container.innerHTML = '';

            if (selectedFiles.length === 0) {
                return;
            }

            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <button type="button" class="remove-btn" onclick="removeFile(${index})" title="Remove">Ã—</button>
                        <div class="file-info">${file.name}</div>
                    `;
                    
                    container.appendChild(previewItem);
                };
                
                reader.readAsDataURL(file);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayPreviews();
        }

        // Update form submission to use selectedFiles
        document.querySelector('form').addEventListener('submit', function(e) {
            if (selectedFiles.length === 0) {
                e.preventDefault();
                alert('Please select at least one image');
                return false;
            }

            // Create new FormData and add files
            const formData = new FormData(this);
            formData.delete('file'); // Remove any existing files
            
            selectedFiles.forEach(file => {
                formData.append('file', file);
            });

            // Submit form with fetch
            e.preventDefault();
            
            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('active');
            
            // Also update button state
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span>Analyzing...';
            
            fetch('/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('Network response was not ok');
            })
            .then(html => {
                document.open();
                document.write(html);
                document.close();
            })
            .finally(() => {
                // Reset loading state on error or success
                loadingOverlay.classList.remove('active');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Analyze Now';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error processing images');
                // Reset button state on error
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Analyze Now';
            });
        });
    </script>
</body>

</html>